<!DOCTYPE html><html><head><title>Cybozu Frontend Monthly #9</title><meta name="description" content="サイボウズのフロントエンドエキスパートチームが月イチでお届けするフロントエンド情報"/><meta name="og:description" content="サイボウズのフロントエンドエキスパートチームが月イチでお届けするフロントエンド情報"/><meta name="og:title" content="Cybozu Frontend Monthly #9"/><meta name="og:type" content="website"/><meta name="og:image" content="https://cybozu.github.io/frontend-monthly/assets/img/header.png"/><meta name="twitter:title" content="Cybozu Frontend Monthly #9"/><meta name="twitter:description" content="サイボウズのフロントエンドエキスパートチームが月イチでお届けするフロントエンド情報"/><meta name="twitter:card" content="summary"/><meta name="twitter:creator" content="Cybozu Frontend Expert Team"/><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.21.0/themes/prism.min.css"/><meta name="next-head-count" content="14"/><link rel="preload" href="/_next/static/css/de019082f7bd6e5c1d8d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/de019082f7bd6e5c1d8d.css" data-n-g=""/><link rel="preload" href="/_next/static/css/dfdf5f649880e41cbd5c.css" as="style"/><link rel="stylesheet" href="/_next/static/css/dfdf5f649880e41cbd5c.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="/_next/static/chunks/webpack-377d9957422d331503bc.js" defer=""></script><script src="/_next/static/chunks/framework-92300432a1172ef1338b.js" defer=""></script><script src="/_next/static/chunks/main-08911db57cbb5406b625.js" defer=""></script><script src="/_next/static/chunks/pages/_app-0eda503e19a294e1d1a6.js" defer=""></script><script src="/_next/static/chunks/423-4bcace61643c26d7ea4d.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bslug%5D-ef2fc0284b56e952f610.js" defer=""></script><script src="/_next/static/NpWyftPghPL3KcdiNy9a1/_buildManifest.js" defer=""></script><script src="/_next/static/NpWyftPghPL3KcdiNy9a1/_ssgManifest.js" defer=""></script></head><body><div id="__next"><style data-emotion="css crwfbk">.css-crwfbk{display:grid;grid-template-rows:auto 1fr auto;height:100vh;box-sizing:border-box;}.css-crwfbk .main{box-sizing:border-box;min-width:200px;max-width:980px;width:100%;margin:0 auto;padding:15px 45px;color:#24292e;}.css-crwfbk .main h1{margin-top:0;}@media (max-width: 767px){.css-crwfbk .main{padding:12px;font-size:14px;}.css-crwfbk .main .markdown-body{font-size:14px;}.css-crwfbk .main h1{font-size:1.55em;margin-bottom:0.25em;margin-top:0.5em;}.css-crwfbk .main h2{font-size:1.3em;margin-bottom:0.25em;margin-top:0.5em;}.css-crwfbk .main h3{font-size:1.1em;margin-bottom:0.25em;margin-top:0.5em;}.css-crwfbk .main hr{margin:12px 0;}}.css-crwfbk .footer{background-color:#31424e;text-align:center;color:#f8f8ff;font-size:0.75em;padding:5px 0;}.css-crwfbk .footer a{color:inherit;}</style><div class="markdown-body css-crwfbk"><main class="main"><style data-emotion="css e4jomx">.css-e4jomx .markdown-body img{border:1px solid rgba(0, 0, 0, 0.1);max-width:90%;height:auto;margin:12px auto;display:block;}.css-e4jomx .markdown-body li>p{margin:8px 0;}@media screen and (max-width: 420px){.css-e4jomx .markdown-body{font-size:14px;}.css-e4jomx .markdown-body li>p{margin:4px 0;}}.css-e4jomx h1{margin-top:0;}.css-e4jomx >h1:first-of-type{margin-top:0!important;}.css-e4jomx h3{position:relative;margin-left:-5px;padding-left:5px;}.css-e4jomx h3:hover .icon.icon-link{position:absolute;right:calc(100%);}.css-e4jomx h3:hover .icon.icon-link:before{font-size:0.75em;content:"🔗";}</style><article class="css-e4jomx"><h1>Cybozu Frontend Monthly #9</h1><div><img src="/assets/img/header.png" width="659" height="229" alt=""/></div><h2>イベント概要</h2><p><strong>サイボウズフロントエンドマンスリー</strong>は、サイボウズ社内で行っているフロントエンド情報共有会「フロントエンドウィークリー」の公開版です。</p><p>その月に気になったフロントエンドの情報を、サイボウズのフロントエンドエキスパートチームのメンバーが共有していきます。</p><p><strong>このイベントのハッシュタグは<!-- --> <a href="https://twitter.com/search?q=%23%E3%82%B5%E3%82%A4%E3%83%9C%E3%82%A6%E3%82%BA%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9E%E3%83%B3%E3%82%B9%E3%83%AA%E3%83%BC" target="_blank" rel="noopener noreferrer">#サイボウズフロントエンドマンスリー</a> <!-- -->です。</strong></p><style data-emotion="css y47mw7">.css-y47mw7 h3{margin-top:0;}.css-y47mw7 p{margin-bottom:0;white-space:pre-line;}</style><pre class="css-y47mw7"><h3>※フロントエンドウィークリーとは</h3><p>毎週火曜の 17:00 〜 18:00 で社内向けに行っているフロントエンドの気になる記事を紹介する会です。2016年3月15日から行われています。<br/>ハッシュタグ<!-- --> <a href="https://twitter.com/search?q=%23%E3%82%B5%E3%82%A4%E3%83%9C%E3%82%A6%E3%82%BA%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E3%82%A6%E3%82%A3%E3%83%BC%E3%82%AF%E3%83%AA%E3%83%BC" target="_blank" rel="noopener noreferrer">#サイボウズフロントエンドウィークリー</a> <!-- -->で実況しています。</p></pre><h3>開催日</h3><p>2021年03月30日</p><h3>イベントページ</h3><p><a href="https://cybozu.connpass.com/event/208515/" target="_blank" rel="noopener noreferrer">https://cybozu.connpass.com/event/208515/</a></p><h3>配信URL</h3><style data-emotion="css 14br0ti">.css-14br0ti .embed{display:block;max-width:100%;max-height:280px;}</style><p class="css-14br0ti"><iframe title="https://www.youtube.com/embed/AZy7IvmMRjE" width="560" height="315" src="https://www.youtube.com/embed/AZy7IvmMRjE" frameBorder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen="" class="embed"></iframe><a href="https://www.youtube.com/watch?v=AZy7IvmMRjE" target="_blank" rel="noreferrer noopner">https://www.youtube.com/watch?v=AZy7IvmMRjE</a></p><h3>タイムテーブル</h3><table><tbody><tr><td>07:50 - 08:00</td><td>配信開始</td></tr><tr><td>08:00 - 08:05</td><td>オープニング</td></tr><tr><td>08:05 - 08:55</td><td>本編</td></tr><tr><td>08:55 - 09:00</td><td>クロージング</td></tr></tbody></table><h2>メンバー</h2><style data-emotion="css 1g63iqu">.css-1g63iqu{display:grid;grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));grid-gap:24px 12px;padding:12px;}.css-1g63iqu .member{text-align:center;}.css-1g63iqu .thumbnail{border-radius:50%;margin:0 auto 5px;}</style><div class="css-1g63iqu"><div class="member"><img class="thumbnail" src="/assets/photo/f8079885d680213e64e4d706daa4a5ee_400x400.jpeg" width="100" height="100" alt=""/><a href="https://twitter.com/koba04" target="_blank" rel="noopener noreferrer">@koba04</a></div><div class="member"><img class="thumbnail" src="/assets/photo/a95b52be00e06cd293a6853bc36490bc_400x400.jpeg" width="100" height="100" alt=""/><a href="https://twitter.com/pirosikick" target="_blank" rel="noopener noreferrer">@pirosikick</a></div><div class="member"><img class="thumbnail" src="/assets/photo/erghEqaW_400x400.png" width="100" height="100" alt=""/><a href="https://twitter.com/__sakito__" target="_blank" rel="noopener noreferrer">@__sakito__</a></div><div class="member"><img class="thumbnail" src="/assets/photo/A9M8G6DH_400x400.jpg" width="100" height="100" alt=""/><a href="https://twitter.com/shisama_" target="_blank" rel="noopener noreferrer">@shisama_</a></div><div class="member"><img class="thumbnail" src="/assets/photo/EKNVNzOg_400x400.jpg" width="100" height="100" alt=""/><a href="https://twitter.com/nakajmg" target="_blank" rel="noopener noreferrer">@nakajmg</a></div><div class="member"><img class="thumbnail" src="/assets/photo/QySbTwnO_400x400.jpg" width="100" height="100" alt=""/><a href="https://twitter.com/b4h0_c4t" target="_blank" rel="noopener noreferrer">@b4h0_c4t</a></div><div class="member"><img class="thumbnail" src="/assets/photo/7iJNhdua_400x400.jpg" width="100" height="100" alt=""/><a href="https://twitter.com/__sosukesuzuki" target="_blank" rel="noopener noreferrer">@__sosukesuzuki</a></div></div><h2>ゲスト</h2><div class="css-1g63iqu"><div class="member"><img class="thumbnail" src="/assets/photo/1mSWaTJY_400x400.jpeg" width="100" height="100" alt=""/><a href="https://twitter.com/narirow" target="_blank" rel="noopener noreferrer">@narirow</a></div><div class="member"><img class="thumbnail" src="/assets/photo/387943_158685184235470_100002819679575_201710_1252547332_n_400x400.jpg" width="100" height="100" alt=""/><a href="https://twitter.com/koh110" target="_blank" rel="noopener noreferrer">@koh110</a></div></div><hr/><h2>紹介記事</h2><div class="markdown-body"><h3 id="compat2021-eliminating-five-top-compatibility-pain-points-on-the-web"><a href="#compat2021-eliminating-five-top-compatibility-pain-points-on-the-web" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><a href="https://web.dev/compat2021/" target="_blank" rel="nofollow">Compat2021: Eliminating five top compatibility pain points on the web</a></h3>
<ul>
<li>共有者: sakito</li>
</ul>
<p>Compat2021という取り組みの紹介記事になります。
同時に<a href="https://blogs.windows.com/msedgedev/2021/03/22/better-compatibility-compat2021/" target="_blank" rel="nofollow">マイクロソフト</a>、<a href="https://www.igalia.com/2021/03/22/Igalia-and-Compat2021.html" target="_blank" rel="nofollow">Igalia</a>からもCompat2021についての各社の取り組みについて記事が公開されています。</p>
<p><a href="https://insights.developer.mozilla.org/reports/mdn-browser-compatibility-report-2020.html" target="_blank" rel="nofollow">WebDNA</a>などを通して行われてきた調査で浮き彫りになった開発者が感じている問題について「ブラウザーの互換性」が多くあがっており、その問題について改善していくという内容になっています。
特にCSS関連でCSS Flexbox, CSS Grid, CSS position: sticky, CSS aspect-ratio property, CSS transformsが各ブラウザで微妙に挙動が異なることによる辛さが多く挙げられているので、ここを2021年は改善していくとのことです。</p>
<p>記事では具体的にどのような挙動の差があるのかもまとまっています。</p>
<p><a href="https://groups.google.com/g/compat2021" target="_blank" rel="nofollow">メーリングリスト</a>や<a href="https://wpt.fyi/compat2021?feature=summary" target="_blank" rel="nofollow">web-platform-tests dashboard - Compat 2021 Dashboard</a>で情報を追いかけることができるのと、今後も継続的にこの問題について情報があがってくるようです。</p>
<p>Chromium以外にもGeckoやWebKitも改善されないと意味がないような気がしますが、WebKitについてはIgaliaが取り組みについて触れているのでIgaliaがWebKitに協力していき、ほかのベンダーが共同でブラウザの改善に取り組むのかもしれません。</p>
<p>CSSの微妙な違いについてはかなり直面するケースでもあり、確認も大変なので嬉しい取り組みだと思います。</p>
<hr>
<h3 id="テキストに隠し情報を埋め込むnpmモジュールを公開しました"><a href="#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%AB%E9%9A%A0%E3%81%97%E6%83%85%E5%A0%B1%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80npm%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E5%85%AC%E9%96%8B%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><a href="https://zenn.dev/redshoga/articles/ca28db8afd6b44" target="_blank" rel="nofollow">テキストに隠し情報を埋め込むnpmモジュールを公開しました</a></h3>
<ul>
<li>共有者: nakajmg</li>
</ul>
<p>電子透かしを入れることなどを目的とした、表示されない文字を使ってテキストにデータを埋め込む話。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">テ​​​‌‌‌​​​‌‌‌‌‌​‌​‌​​‌​‌​​​​‌‌‌​​​‌‌‌‌‌​‌​‌​‌‌​‌‌キ​​​‌‌‌​​​‌‌‌‌‌​​​‌‌​​​‌‌​​​‌‌‌​​​‌‌‌‌‌​‌​‌​‌‌​​‌ス​​​‌‌‌​​​‌‌‌‌‌​‌​‌​​​‌​‌​​​‌‌‌​​​‌‌‌‌‌​​​‌‌​‌​‌​ト​​​‌‌‌​​​‌‌‌‌‌​​​‌​‌​​‌​​​​‌‌‌​​​‌‌‌‌‌​​​‌​​‌‌​​を​​​‌‌‌​​​‌‌‌‌‌​​​‌‌‌​‌‌‌​​​‌‌‌​​​‌‌‌‌‌​‌​‌​‌​‌‌‌コ​​​‌‌‌​​​‌‌‌‌‌​​​‌​​‌‌​​​​​‌‌‌​​​‌‌‌‌‌​​​‌‌‌​‌‌​ピ​​​‌‌‌​​​‌‌‌‌‌​​​‌‌​​​​‌​​​‌‌‌​​​‌‌‌‌‌​​​‌​​‌‌​​ー​​​‌‌‌​​​‌‌‌‌‌​‌​‌​​​‌‌​​​​‌‌‌​​​‌‌‌‌‌​​​‌​‌​‌​‌し​​​‌‌‌​​​‌‌‌‌‌​​​‌​​​​‌‌てね</code></pre></div>
<p>👆のテキストをコピーして <a href="https://zero-width-watermark-web.vercel.app/" target="_blank" rel="nofollow">https://zero-width-watermark-web.vercel.app/</a> で XTRACT MODEにしてコピペしてExtractを実行すると…。</p>
<p>👐</p>
<p>実装としてはテキストをUint8Arrayに変換して<code>0</code>と<code>1</code>をゼロ幅文字(<code>0x200c</code>と<code>0x200b</code>)に変換して埋め込んでいます。</p>
<p>この手法は数年前に話題になったことがありました。</p>
<p><a href="https://labs.cybozu.co.jp/blog/akky/2018/04/leaker-detection-by-zero-width-characters/" target="_blank" rel="nofollow">ゼロ幅文字にエンコードした隠し情報で、文書をリークしたメンバーを特定</a></p>
<hr>
<h3 id="how-mdns-site-search-works---mozilla-hacks---the-web-developer-blog"><a href="#how-mdns-site-search-works---mozilla-hacks---the-web-developer-blog" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><a href="https://hacks.mozilla.org/2021/03/how-mdns-site-search-works/" target="_blank" rel="nofollow">How MDN's site-search works - Mozilla Hacks - the Web developer blog</a></h3>
<ul>
<li>共有者: zaki___yama</li>
</ul>
<p>リニューアルしたMDNのサイト内検索のしくみの話。</p>
<p>2021年2月時点で、MDNには</p>
<ul>
<li>英語のドキュメントが 11,619 ページ</li>
<li>翻訳されたドキュメントが約 40,000 ページ</li>
<li>英語だけで 530 万語</li>
</ul>
<p>存在するそうです。
ビルド時にこれらのデータを全文検索データベースに突っ込んでインデックスする、ということをやっています。
データベースとして現在採用しているのは Elasticsearch です。</p>
<h4 id="サイト全体のアーキテクチャ"><a href="#%E3%82%B5%E3%82%A4%E3%83%88%E5%85%A8%E4%BD%93%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>サイト全体のアーキテクチャ</h4>
<p>以下の図がわかりやすい。</p>
<p><img src="https://hacks.mozilla.org/files/2021/03/Untitled-Diagram-4.png" alt="mdn-architecture"></p>
<p>サイトのコンテンツを Elasticsearch に突っ込む、という処理を GitHub Actions で定期実行しています。 (24h おき)
また、検索時はフロントエンドからの fetch() リクエストを一旦 Django で構築したバックエンドが受け取り、クエリのバリデーションや整形をした後 Elasticsearch に送っています。</p>
<h4 id="インデックス化までの流れ"><a href="#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E5%8C%96%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>インデックス化までの流れ</h4>
<ul>
<li>ビルド時、コンテンツから index.html と一緒に index.json というデータを生成する。これは以下のようなデータ</li>
</ul>
<div class="remark-highlight"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"doc"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"DOCUMENT TITLE"</span><span class="token punctuation">,</span>
    <span class="token property">"summary"</span><span class="token operator">:</span> <span class="token string">"DOCUMENT SUMMARY"</span><span class="token punctuation">,</span>
    <span class="token property">"body"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">"type"</span><span class="token operator">:</span> <span class="token string">"prose"</span><span class="token punctuation">,</span> 
        <span class="token property">"value"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token property">"id"</span><span class="token operator">:</span> <span class="token string">"introduction"</span><span class="token punctuation">,</span> 
          <span class="token property">"title"</span><span class="token operator">:</span> <span class="token string">"INTRODUCTION"</span><span class="token punctuation">,</span>
          <span class="token property">"content"</span><span class="token operator">:</span> <span class="token string">"&#x3C;p>FIRST BLOCK OF TEXTS&#x3C;/p>"</span>
       <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
     ...
   <span class="token punctuation">]</span><span class="token punctuation">,</span>
   <span class="token property">"popularity"</span><span class="token operator">:</span> <span class="token number">0.12345</span><span class="token punctuation">,</span>
   ...
<span class="token punctuation">}</span>
</code></pre></div>
<ul>
<li>Python のスクリプトで、index.json のHTMLからタグを取り除いた純粋なコンテンツを得る
<ul>
<li>これは <code>&#x3C;p>Some &#x3C;em>cool&#x3C;/em> text.&#x3C;/p></code> -> <code>Some cool text.</code> のような単純な処理だけではなく、 <code>&#x3C;div class="hidden"></code> や <code>&#x3C;div class="notecard warning"></code> なども取り除く必要がある</li>
</ul>
</li>
<li>Elasticsearch に送る</li>
<li>...という処理を 24 時間おきに GitHub Actions で実行
<ul>
<li>production build 用の GitHub Action はおそらく <a href="https://github.com/mdn/yari/blob/main/.github/workflows/prod-build.yml" target="_blank" rel="nofollow">prod-build.yml</a></li>
</ul>
</li>
<li>削除されたページのインデックスなどを考慮し、Elasticsearch 側は毎回インデックスを全削除 -> 再作成している</li>
</ul>
<h4 id="検索"><a href="#%E6%A4%9C%E7%B4%A2" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>検索</h4>
<ul>
<li>フロントエンドからは <code>fetch()</code> で <code>GET /api/v1/search?q=foo&#x26;locale=fr</code> のようなエンドポイントを叩く</li>
<li>バックエンドでは Django のアプリがこのクエリをバリデーションし Elasticsearch 用のクエリに変換して検索
<ul>
<li>elasticsearch-dsl というライブラリを使っている</li>
</ul>
</li>
<li>検索結果のソート：popularity という数値を定義し、popularity と matchness を組み合わせてソートしてる
<ul>
<li>popularity: Google Analytics の PV 数（定期的にダウンロードしてる）を 0 ~ 1 の値に正規化したもの</li>
</ul>
</li>
</ul>
<hr>
<h3 id="error-cause-in-javascript---dev-community"><a href="#error-cause-in-javascript---dev-community" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><a href="https://dev.to/hemanth/error-cause-in-javascript-425d" target="_blank" rel="nofollow">Error Cause in JavaScript - DEV Community</a></h3>
<ul>
<li>共有者: pirosikick</li>
</ul>
<p>Errorのコンストラクタの第2引数に他のエラーを渡すことができるプロポーザルについて。知らぬ間にもうStage 3になっていた。
下流で起きたエラーを上流に流していく過程で、エラーメッセージを連結したり、独自のエラーを作ったりせずに、
このような言語で公式の方法ができると色々と使いまわしがよさそう。
（Golangではエラーをラップして返すのはおなじみで、結構便利。）</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cause <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'…'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'…'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cause <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token property-access">cause</span> <span class="token operator">===</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>
</code></pre></div>
<p>同じようなことをやってくれる<a href="https://www.npmjs.com/package/verror" target="_blank" rel="nofollow">verror</a>というのがあるが、
たぶんUniversalじゃないし、そこまでメジャーでは無い気がする。
この提案をベースに、Golangの<code>errors.As</code>みたいなのを作ると便利そう。</p>
<div class="remark-highlight"><pre class="language-ts"><code class="language-ts"><span class="token comment">// errがtype型のErrorをcauseに持っている場合に返す</span>
<span class="token comment">// 適当に書いたので間違いあるかも！</span>
<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">errorAs</span><span class="token generic class-name"><span class="token operator">&#x3C;</span>
  <span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token punctuation">{</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> InstanceType<span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token punctuation">}</span>
<span class="token operator">></span></span></span><span class="token punctuation">(</span>err<span class="token operator">:</span> Error<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> InstanceType<span class="token operator">&#x3C;</span><span class="token constant">T</span><span class="token operator">></span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token punctuation">{</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token keyword">instanceof</span> <span class="token class-name"><span class="token keyword">type</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    err <span class="token operator">=</span> err<span class="token punctuation">.</span>cause<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> cause <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyError</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'...'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> cause <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> e <span class="token operator">=</span> <span class="token function">errorAs</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> MyError<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// eはMyErrorとして扱える</span>
<span class="token punctuation">}</span>
</code></pre></div>
<hr>
<h3 id="post-spectre-web-development"><a href="#post-spectre-web-development" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><a href="https://www.w3.org/TR/2021/WD-post-spectre-webdev-20210316/" target="_blank" rel="nofollow">Post-Spectre Web Development</a></h3>
<ul>
<li>共有者: shisama</li>
</ul>
<p>Spectre以降のWeb開発について脅威モデルと対策の実践例が解説されているドキュメントがW3CのWorking Draft(草案)として公開されました。元々GoogleのMike West氏が書いた文書でしたがW3C organizationに移りました。<br>
Spectreのようなサイドチャネル攻撃はハードウェアの脆弱性に起因するものなので、Same-Origin Policyでは防ぐことができません。機密情報が攻撃者によって操作可能なプロセスの中にあった場合、サイドチャネル攻撃によって情報の推測がされることが実証されています。JavaScriptを使ったSpectreのPoCも公開されました。</p>
<ul>
<li><a href="https://security.googleblog.com/2021/03/a-spectre-proof-of-concept-for-spectre.html" target="_blank" rel="nofollow">Google Online Security Blog: A Spectre proof-of-concept for a Spectre-proof web</a></li>
</ul>
<p>プロセスレベルでサイトを分離するChromiumの<a href="https://www.chromium.org/Home/chromium-security/site-isolation" target="_blank" rel="nofollow">Site Isolation</a>やFirefoxの<a href="https://wiki.mozilla.org/Project_Fission" target="_blank" rel="nofollow">Project Fission</a>があり、これらはデフォルトで有効となっているため、eTLD+1が異なるURLのサイトはプロセスが別となります。<br>
ただ、すべてのブラウザがこれを実装するのは難しいため、Opt-inで対策可能なHTTPヘッダーを用意しています。</p>
<p>この文書ではそれらのHTTPヘッダーの設定方法が詳しく紹介されています。<br>
『<a href="https://developers-jp.googleblog.com/2021/03/blog-post_29.html" target="_blank" rel="nofollow">Google Developers Japan: サイドチャネル攻撃への対策</a>』でも紹介されている内容+補足は以下の通り。<br>
これはW3CのドキュメントのTL;DRにも書かれている内容です。</p>
<ol>
<li>受信したヘッダーを調べ、一方で Origin ヘッダー、もう一方で Sec-Fetch- で始まる各ヘッダーに注目し、<strong>リクエストに応答するべきかどうかを判断します</strong>。
<ul>
<li>(補足)<code>Sec-Fetch-*</code>からはじまるFetch Metadataはリクエスト時にChromeによって自動で付与されます。Fetch Metadataにはどこからきたどのようなリクエストかの情報が含まれています。</li>
</ul>
</li>
<li><strong>攻撃者がリソースをサブリソースとして読み込む機能を制限します</strong>。これをするには、Cross-Origin Resource Policy として same-origin を設定します（必要な場合のみ、same-site または cross-origin にします）。
<ul>
<li>(補足)配信されるリソースに設定します。CDNなどで配信しているようなCross-Originで使われるリソースには値にcross-originを設定する必要があります。</li>
</ul>
</li>
<li><strong>攻撃者がリソースをドキュメントとしてフレームに含めることができるかを制限します</strong>。これをするには、X-Frame-Options: SAMEORIGIN を使ってフレーム化保護にオプトインするか、さらに細かい制御が可能な CSP の frame-ancestors ディレクティブを使います。たとえば、<code>frame-ancestors 'self' https://trusted.embedder</code> とします。
<ul>
<li>(補足)iframeなどに埋め込めることができるページをSame-Originに制限したり、指定したOriginのみに制限できます。</li>
</ul>
</li>
<li><strong>攻撃者がアプリケーションのウィンドウを参照する機能を制限します</strong>。これをするには、Cross-Origin Opener Policy を設定します。制限が強い same-origin 値をデフォルトとし、必要な場合のみ same-origin-allow-popups または unsafe-none にするのが最適です。
<ul>
<li>(補足) <code>Cross-Origin-Opener-Policy: same-origin</code>が設定されているページから新しいウィンドウで開かれたCross-Originなページからは<code>window.opener</code>の値がnullになります。</li>
</ul>
</li>
<li><strong>MIME-type confusion 攻撃を防ぎ</strong>、Cross-Origin Read Blocking（クロスオリジン読み込みブロック）などの消極的防御の確実性を高めます。これをするには、正しい Content-Type ヘッダーを設定し、X-Content-Type-Options: nosniff となっていることをグローバルで確認します。
<ul>
<li>(補足)<code>&#x3C;img></code>や<code>&#x3C;script></code>を使って機密情報が含まれたHTMLやJSONを取得することを利用したサイドチャネル攻撃がある。たとえば<code>&#x3C;img src="https://example.com/secret.json"></code>のようなリクエストを攻撃者のサイトから行われたとき、見た目上は画像のパースに失敗して表示されないだけだが、攻撃者のコードのあるプロセス内のメモリに展開される。メモリに展開されたデータはサイドチャネル攻撃により推測可能となる。CORBはこのようなメモリへの展開を防ぐことができる機能です。</li>
</ul>
</li>
</ol>
<p>W3Cのドキュメントにはこれらの内容について実際のHTTPヘッダーの設定例をケースごとに実例を交えて解説しています。</p>
<p>また、『<a href="https://www.w3.org/TR/2021/WD-post-spectre-webdev-20210316/#documents-isolated" target="_blank" rel="nofollow">2.2.1. Fully-Isolated Documents</a>』のNoteにも書かれていますが、Chrome 91からSharedArrayBufferを使うためにはCross-Origin Isolateな状態でないと利用できなくなります。</p>
<ul>
<li><a href="https://developer.chrome.com/blog/enabling-shared-array-buffer/#cross-origin-isolation" target="_blank" rel="nofollow">SharedArrayBuffer updates in Android Chrome 88 and Desktop Chrome 91 - Chrome Developers</a></li>
</ul>
<p>これらの機能を使うためには次のようにCross-Originなページからのアクセスを防ぐ設定が必要です。</p>
<div class="remark-highlight"><pre class="language-unknown"><code class="language-unknown">Cross-Origin-Embedder-Policy: require-corp
Cross-Origin-Opener-Policy: same-origin</code></pre></div>
<p>Performance APIなどもSite IsolationやこれらのHTTPヘッダーの設定が必要です。サイドチャネル攻撃の可能性があるAPIはCross-Origin Isolatedでないと使えないようになるかもしれません。　　
どのように設定すればいいか迷ったときはこのドキュメントを参考に設定すると良さそうです。</p>
<hr>
<h3 id="sharedarraybuffer"><a href="#sharedarraybuffer" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>SharedArrayBuffer</h3>
<ul>
<li>共有者: koh110</li>
</ul>
<p>Chrome 91からSharedArrayBufferの利用するためにヘッダーを返さなければならなくなりました。</p>
<p><a href="https://developer.chrome.com/blog/enabling-shared-array-buffer/" target="_blank" rel="nofollow">https://developer.chrome.com/blog/enabling-shared-array-buffer/</a></p>
<ul>
<li>使っているつもりはなかったが検出された</li>
<li>Next.jsが入れているっぽい
<ul>
<li><a href="https://github.com/vercel/next.js/issues/21708" target="_blank" rel="nofollow">https://github.com/vercel/next.js/issues/21708</a></li>
<li>依存して検出されてしまっているが影響はない</li>
</ul>
</li>
<li>Reactの依存だった
<ul>
<li>最終的にSharedArrayBufferへの依存が削除された</li>
<li><a href="https://github.com/facebook/react/releases/tag/v17.0.2" target="_blank" rel="nofollow">https://github.com/facebook/react/releases/tag/v17.0.2</a></li>
<li><a href="https://github.com/facebook/react/pull/20840" target="_blank" rel="nofollow">https://github.com/facebook/react/pull/20840</a></li>
<li>セキュリティなどの重大なissueではないためv16へのバックポートはない</li>
</ul>
</li>
</ul>
<p>もとをたどるとScheduler(React内部パッケージ)のプロファイリング機能で使われている</p>
<h4 id="scheduler"><a href="#scheduler" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Scheduler</h4>
<p>元々はreact-schedulerというパッケージ<br>
react-scheduler -> schedule -> scheduler<br>
<a href="https://github.com/facebook/react/pull/13543" target="_blank" rel="nofollow">https://github.com/facebook/react/pull/13543</a><br>
<a href="https://github.com/facebook/react/pull/13683" target="_blank" rel="nofollow">https://github.com/facebook/react/pull/13683</a><br>
<a href="https://github.com/facebook/react/tree/master/packages/scheduler" target="_blank" rel="nofollow">https://github.com/facebook/react/tree/master/packages/scheduler</a></p>
<p>中身を読んでみるとイベントキューのようなもの<br>
<a href="https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js" target="_blank" rel="nofollow">https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js</a></p>
<p>renameが繰り返されるうちに説明文が消えたっぽい。<br>
requestAnimationFrameやrequestIdleCallbackより細かい優先度をつけて実行するというモチベーション。<br>
<a href="https://github.com/facebook/react/blob/8a1e3962ab189b99b1593d8431feabcb4a21211b/packages/react-scheduler/src/ReactScheduler.js#L12-L23" target="_blank" rel="nofollow">https://github.com/facebook/react/blob/8a1e3962ab189b99b1593d8431feabcb4a21211b/packages/react-scheduler/src/ReactScheduler.js#L12-L23</a></p>
<p>Node.js + 古いIE環境を判定するために <code>typeof setImmediate</code> をみてるのがちょっと面白い。
<a href="https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js#L555-L556" target="_blank" rel="nofollow">https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js#L555-L556</a></p>
<h4 id="profiler"><a href="#profiler" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Profiler</h4>
<p><a href="https://reactjs.org/docs/profiler.html" target="_blank" rel="nofollow">https://reactjs.org/docs/profiler.html</a>
<a href="https://gist.github.com/bvaughn/8de925562903afd2e7a12554adcdda16" target="_blank" rel="nofollow">https://gist.github.com/bvaughn/8de925562903afd2e7a12554adcdda16</a></p>
<p>Schedulerのプロファイリングには2つのアプローチが採用されている<br>
<a href="https://github.com/facebook/react/pull/16145" target="_blank" rel="nofollow">https://github.com/facebook/react/pull/16145</a><br>
<a href="https://github.com/facebook/react/pull/16542" target="_blank" rel="nofollow">https://github.com/facebook/react/pull/16542</a></p>
<ul>
<li>sample base
<ul>
<li>workerからSchedulerの現在の状態を読み取る</li>
<li>workerとSchedulerのデータを共有するためにSharedArrayBufferが使われている</li>
</ul>
</li>
<li>event base
<ul>
<li>Workerが初期化される前にプロファイリングするためのもの</li>
</ul>
</li>
</ul>
<p>プロファイリングはdevelopmentビルドでしか有効にされていないため、SharedArrayBufferの問題はproduction環境では起きないはず。</p>
<p>production環境でSharedArrayBufferの警告が出ている場合developmentビルドのままリリースしている可能性やProfilerをonにしている可能性があるので、アップデートできない環境やフレームワークで依存している場合は気にしてみるとよいかも。<br>
<a href="https://gist.github.com/bvaughn/25e6233aeb1b4f0cdb8d8366e54a3977" target="_blank" rel="nofollow">https://gist.github.com/bvaughn/25e6233aeb1b4f0cdb8d8366e54a3977</a></p>
<hr>
<h3 id="tc39-2020-march0309-0310"><a href="#tc39-2020-march0309-0310" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>TC39 2020 March(<a href="https://github.com/tc39/notes/blob/master/meetings/2021-03/mar-9.md" target="_blank" rel="nofollow">03/09</a>, <a href="https://github.com/tc39/notes/blob/master/meetings/2021-03/mar-10.md" target="_blank" rel="nofollow">03/10</a>)</h3>
<ul>
<li>共有者: @__sosukesuzuki</li>
</ul>
<p>数が多いのでいくつか興味深いかつあんまりメジャーではなさそうなものをあえて紹介。</p>
<h4 id="class-static-initialization-blocks"><a href="#class-static-initialization-blocks" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Class Static Initialization Blocks</h4>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token maybe-class-name">Class</span> <span class="token maybe-class-name">Foo</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token property-access">foo</span> <span class="token operator">=</span> <span class="token string">"foo"</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>現在条件付きのStage-3。</p>
<p>前回の論点は２つあった。</p>
<p>一つはクラスごとに複数のStatic Blocksを許可するかどうかという点だった。結論としては、クラスは任意の数のStatic Blocksを含むことができるようになった。</p>
<p>もう一つは、Static Blocks内での<code>new.target</code>挙動についてだった。結論としては、メソッドと同じようにundefinedを返す必要があるということになった。</p>
<p>この提案の中ではStatic Blocksに対するデコレータの扱いはサポートしていない。最終的にデコレータによるサポートが必要なのであれば、それはデコレータの提案の一部もしくは別のものとして議論する。</p>
<p>SpiderMonkeyやV8ではすでに実装が始まっている。</p>
<h4 id="records-and-tuples-update"><a href="#records-and-tuples-update" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Records and Tuples update</h4>
<p>現在Stage-2。</p>
<p>2019年10月のStage-1のときのスライドでの議論に戻るが、TuplesやRecordsのために書いたコードは配列やオブジェクトに対しても動作するべきである。最近になって、配列のメソッドとTuplesのメソッドを照らし合わせていたところ、配列を操作する<code>popped</code>, <code>pushed</code>, <code>reversed</code>, <code>shifted</code>, <code>spliced</code>, <code>unshifted</code>, <code>with</code> などのメソッドが配列には存在しないことがわかった。</p>
<p>もしこれらのメソッドが<code>Array.prototype</code>に存在すれば、この例のように配列を無駄にコピーする必要がなくなる。</p>
<div class="remark-highlight"><pre class="language-diff"><code class="language-diff"><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> const a2 = [...a1].reverse();</span>
<span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const a2 = a1.reversed();</span>
<span class="token line"></span></span><span class="token deleted-sign deleted"><span class="token prefix deleted">-</span><span class="token line"> const a3 = [...a2].sort();</span>
<span class="token line"></span></span><span class="token inserted-sign inserted"><span class="token prefix inserted">+</span><span class="token line"> const a3 = a2.sorted();</span></span>
</code></pre></div>
<p>Tuplesのみならず配列にとっても有用なものである可能性が高い。</p>
<p>なので、これらのメソッドを<code>Array.prototype</code>や<code>Tuple.prototype</code>に追加するというのを Records &#x26; Tuples とは異なる新しいプロポーザルとして管理することが決まった。</p>
<h4 id="async-do-update-towards-stage-2"><a href="#async-do-update-towards-stage-2" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Async Do update towards stage 2</h4>
<p>現在Stage-1。</p>
<p>前回からの変更点が２つある。</p>
<p>1つめは、<code>do</code>のブロックの中で<code>break</code>,<code>continue</code>,<code>return</code>が使えるようになる。アンケートの結果そのような挙動に賛成する人が多かったため仕様に修正が加えられた。</p>
<p>２つ目は、<code>do</code>のブロックの最後の文として、<code>else</code>なしの<code>if</code>は認めないようになった。<code>if</code>の直前の値を返すべきか、<code>undefined</code>を返すべきか不明瞭だからである。</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token comment">// x is 3? or undefined?</span>
<span class="token keyword">const</span> x <span class="token operator">=</span> <span class="token keyword control-flow">do</span> <span class="token punctuation">{</span>
  <span class="token number">3</span>
  <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token number">2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>タイトルは<code>towards stage 2</code>だが、まだ固まっておらず今後設計を洗練させるという結論になった。</p>
<h4 id="promiseanysettled"><a href="#promiseanysettled" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>Promise.anySettled</h4>
<p>これは厳密にはプロポーザルではない。</p>
<p><code>Promise.race</code>は統一性のために<code>Promise.anySettled</code>という名前であるべきではないかという議論。</p>
<table>
<thead>
<tr>
<th>name</th>
<th>description</th>
<th>status</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Promise.allSettled</code></td>
<td>短絡しない</td>
<td>ES2020</td>
</tr>
<tr>
<td><code>Promise.all</code></td>
<td>入力のどれかが失敗したら短絡する</td>
<td>ES2015</td>
</tr>
<tr>
<td><code>Promise.race</code></td>
<td>入力のどれかが完了したら短絡する</td>
<td>ES2015</td>
</tr>
<tr>
<td><code>Promise.any</code></td>
<td>入力のどれかが成功したら短絡する</td>
<td>ES2021</td>
</tr>
</tbody>
</table>
<p>このような表にしてみるとわかりやすくなる。</p>
<p>新しい<code>Promise.anySettled</code>を導入、既存の<code>Promise.race</code>をその別名にして、全く同一の関数オブジェクトを指すようにするという提案。</p>
<p>結論としては、この提案はコンセンサスが得られなかった。</p>
<p>議論であげられている懸念が３つあった。</p>
<p>一つは、一度導入された関数の名前を変更するというのは互換性の観点からよくないということ。具体的にいえばAMPは<code>Promise.race</code>の名前に依存したAPIを提供しているらしい。</p>
<p>もうひとつは、プログラムは書かれることよりも読まれることが多いことを考えると、名前の異なる挙動が全く同じ関数を導入するというのは読み手に対して不親切であるという点。書くのみなら<code>Promise.anySettled</code>のみを覚えておけば問題ないが、読む場合には両方の関数とその関係を把握しておく必要が出てしまう。</p>
<p>最後の懸案は、単純に<code>race</code>と<code>anySettled</code>という２つの言葉の意味には違いがあるという点。ほとんどのPromiseに対する標準のオペレーションは"success confluence"(「計算の結果は、内部の処理の順番に影響されない」)という性質があり、入力のPromiseがすべて成功した場合には成功した順番に影響されない計算結果になるようになっている。<code>Promise.race</code>はこの性質に反する操作であり、それを強調するためにあえてこの名前が使われているらしい。</p>
<hr>
<h3 id="announcing-the-deno-company"><a href="#announcing-the-deno-company" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><a href="https://deno.com/blog/the-deno-company" target="_blank" rel="nofollow">Announcing the Deno Company</a></h3>
<ul>
<li>共有者: b4h0_c4t</li>
</ul>
<p>Deno社が声明を発表していた。</p>
<p>要約すると、</p>
<ul>
<li>Deno(以下、ランタイムを指す)はブラウザAPIに準拠したモダンなプログラミングシステムである</li>
<li>490万ドルのseed capitalを得たことでフルタイムの開発スタッフを確保できたため、タイムリーに開発が進むようになる。</li>
<li>Denoの展開は直接的なマネタイズが目的ではない</li>
</ul>
<p>「490万ドルの資金調達に成功した」あたりが話題性の高い内容なのかなという感じでした。</p>
<hr>
<h3 id="css-aspect-ratio-の各ブラウザ実装が揃いつつある"><a href="#css-aspect-ratio-%E3%81%AE%E5%90%84%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E5%AE%9F%E8%A3%85%E3%81%8C%E6%8F%83%E3%81%84%E3%81%A4%E3%81%A4%E3%81%82%E3%82%8B" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>CSS <code>aspect-ratio</code> の各ブラウザ実装が揃いつつある</h3>
<ul>
<li>共有者: narirow</li>
</ul>
<p>CSSで比率を計算して要素のサイズを表現できる<a href="https://drafts.csswg.org/css-sizing-4/#aspect-ratio" target="_blank" rel="nofollow">aspect-ratio</a>、今月多くのブラウザで実装が進みました。各ブラウザの動向をまとめると以下のようなステータスです。</p>
<ul>
<li>GoogleChrome: <a href="https://groups.google.com/a/chromium.org/g/blink-dev/c/TF41VMfLhMI" target="_blank" rel="nofollow">88でリリース済み (2020年10月)</a>
<ul>
<li>Chrome90でaspect-ratioのCSSアニメーションに対応 (<a href="https://blog.chromium.org/2021/03/chrome-90-beta-av1-encoder-for-webrtc.html" target="_blank" rel="nofollow">参考</a>)</li>
</ul>
</li>
<li>Firefox: <a href="https://groups.google.com/g/mozilla.dev.platform/c/selXOOzcRkU/m/GKxYv-0kAAAJ" target="_blank" rel="nofollow">88でリリース予定 (2021年4月)</a></li>
<li>Safari: <a href="https://trac.webkit.org/changeset/269641/webkit/" target="_blank" rel="nofollow">TechnologyPreview117から徐々に対応、テスト中</a></li>
</ul>
<p>aspect-ratioは、特に画像や映像のあとから読み込みされたときに発生するガタツキ(CLS)が以前より問題視されて、<a href="https://github.com/WICG/intrinsicsize-attribute" target="_blank" rel="nofollow">intrinsicsize</a>などのプロパティを経て、数年間議論が進んでいました。
先立って、<a href="https://developer.mozilla.org/en-US/docs/Web/Media/images/aspect_ratio_mapping#a_new_way_of_sizing_images_before_loading_completes" target="_blank" rel="nofollow">ブラウザの内部ではaspect-ratioを使用したスタイルをあてて、ガタツキが発生しないように調整</a>が行われていたりします。</p>
<p>上記にも上がっていますが、Googleは<a href="https://web.dev/compat2021/" target="_blank" rel="nofollow">Compat2021</a>というプロジェクトを立ち上げ、Webの互換性の問題に取り組んでいます。<a href="https://web.dev/compat2021/#css-aspect-ratio-property" target="_blank" rel="nofollow">aspect-ratioプロパティ</a>はその中でも優先度の高いものとして取り上げられています。</p>
<p>プロダクションで使えるようになるのも、あと少しですね。</p>
<hr>
<h3 id="pwaでもスクリーンショットが登録できるように"><a href="#pwa%E3%81%A7%E3%82%82%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%81%8C%E7%99%BB%E9%8C%B2%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a>PWAでもスクリーンショットが登録できるように</h3>
<ul>
<li>共有者: narirow</li>
</ul>
<p><a href="https://web.dev/add-manifest/#description" target="_blank" rel="nofollow">manifest.json</a>がAndroidChromeで強化されます。
<code>screenshots</code>と、<code>description</code>のフィールドを入力しておくと、アプリストアのような立地なインストール画面を立ち上げることができるようになります。</p>
<p><img src="https://slack-imgs.com/?c=1&#x26;o1=ro&#x26;url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FExo2ZjSWEAMFTKr.jpg" alt="リッチなインストール画面"></p>
<p>(ChromiumDevツイートから転載: <a href="https://twitter.com/ChromiumDev/status/1376472636058927104" target="_blank" rel="nofollow">https://twitter.com/ChromiumDev/status/1376472636058927104</a>)</p>
<hr>
<h3 id="laytoutshiftを効率的にdebugする-webdev--chrome90でcls算出方法がアップデート"><a href="#laytoutshift%E3%82%92%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%ABdebug%E3%81%99%E3%82%8B-webdev--chrome90%E3%81%A7cls%E7%AE%97%E5%87%BA%E6%96%B9%E6%B3%95%E3%81%8C%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88" aria-hidden="true" tabindex="-1"><span class="icon icon-link"></span></a><a href="https://web.dev/debugging-layout-shifts/" target="_blank" rel="nofollow">LaytoutShiftを効率的にdebugする (web.dev)</a> + Chrome90でCLS算出方法がアップデート</h3>
<ul>
<li>共有者: narirow</li>
</ul>
<p>web.devでCoreWebVitalsの一つである、レイアウトシフトのデバッグ方法について詳細に記載れています。
レイアウトシフトに換算される要素は <strong>直近でユーザーの入力に基づいて変更されていない要素</strong>で、これは PerformanceObserverで検出されるデータのうち、<code>hadRecentInput</code>がfalseになっている要素が該当します。</p>
<p>以下のようなスクリプトをChromeのデバッグツールのsnippetを追加したり、bookmarkletとして用意しておくとConsole画面で便利にデバッグ出来ます。</p>
<div class="remark-highlight"><pre class="language-js"><code class="language-js"><span class="token keyword">new</span> <span class="token class-name">PerformanceObserver</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">entryList</span><span class="token punctuation">)</span> <span class="token arrow operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword control-flow">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> entryList<span class="token punctuation">.</span><span class="token method function property-access">getEntries</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword control-flow">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">.</span><span class="token property-access">hadRecentInput</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cls <span class="token operator">+=</span> entry<span class="token punctuation">.</span><span class="token property-access">value</span><span class="token punctuation">;</span>
      <span class="token keyword">debugger</span><span class="token punctuation">;</span>
      <span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">'Current CLS value:'</span><span class="token punctuation">,</span> cls<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">observe</span><span class="token punctuation">(</span><span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'layout-shift'</span><span class="token punctuation">,</span> buffered<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div>
<p>(web.devより転載)</p>
<p>CLSの検出方法は、実は日々アップデートされています。この更新は<a href="https://chromium.googlesource.com/chromium/src/+/master/docs/speed/metrics_changelog/cls.md" target="_blank" rel="nofollow">ChromeSpeed</a>のページから見ることが出来ます。Chrome89から、<code>opacity:0</code>が当てられているような<a href="https://chromium.googlesource.com/chromium/src/+/master/docs/speed/metrics_changelog/2020_12_cls.md" target="_blank" rel="nofollow">目に見えない要素がCLSから換算されなく</a>なり、Chrome90でもこの方向性が強化され、<a href="https://chromium.googlesource.com/chromium/src/+/master/docs/speed/metrics_changelog/2021_02_cls.md" target="_blank" rel="nofollow">空白のテキストやtransformなどの不具合も修正</a>されます。</p>
<p>CoreWebVitalsの対応を行っている方は、Chrome90がリリースされた後、変化が起きないかSearchConsoleから確認してみると良いでしょう。</p>
</div><h2>フロントエンドエキスパートチームについて</h2><style data-emotion="css gz8dae">.css-gz8dae{padding:20px;}</style><div class="css-gz8dae"></div><p style="margin-bottom:0"><a href="https://speakerdeck.com/cybozuinsideout/frontendexpert-team" target="_blank" rel="nofollow noopener noreferrer">https://speakerdeck.com/cybozuinsideout/frontendexpert-team</a></p></article></main><footer class="footer"><a href="/">Cybozu Frontend Monthly</a></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"membersPhotoUrl":{"@koba04":"/assets/photo/f8079885d680213e64e4d706daa4a5ee_400x400.jpeg","@pirosikick":"/assets/photo/a95b52be00e06cd293a6853bc36490bc_400x400.jpeg","@__sakito__":"/assets/photo/erghEqaW_400x400.png","@shisama_":"/assets/photo/A9M8G6DH_400x400.jpg","@nakajmg":"/assets/photo/EKNVNzOg_400x400.jpg","@b4h0_c4t":"/assets/photo/QySbTwnO_400x400.jpg","@__sosukesuzuki":"/assets/photo/7iJNhdua_400x400.jpg","@narirow":"/assets/photo/1mSWaTJY_400x400.jpeg","@koh110":"/assets/photo/387943_158685184235470_100002819679575_201710_1252547332_n_400x400.jpg"},"frontmatter":{"title":"Cybozu Frontend Monthly","date":"2021-03-30T17:00:00+09:00","slug":"2021-03","connpass":"https://cybozu.connpass.com/event/208515/","streamUrl":"https://www.youtube.com/watch?v=AZy7IvmMRjE","no":9,"members":[{"name":"@koba04","link":"https://twitter.com/koba04"},{"name":"@pirosikick","link":"https://twitter.com/pirosikick"},{"name":"@__sakito__","link":"https://twitter.com/__sakito__"},{"name":"@shisama_","link":"https://twitter.com/shisama_"},{"name":"@nakajmg","link":"https://twitter.com/nakajmg"},{"name":"@b4h0_c4t","link":"https://twitter.com/b4h0_c4t"},{"name":"@__sosukesuzuki","link":"https://twitter.com/__sosukesuzuki"}],"guest":[{"name":"@narirow","link":"https://twitter.com/narirow"},{"name":"@koh110","link":"https://twitter.com/koh110"}]},"html":"\u003ch3 id=\"compat2021-eliminating-five-top-compatibility-pain-points-on-the-web\"\u003e\u003ca href=\"#compat2021-eliminating-five-top-compatibility-pain-points-on-the-web\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e\u003ca href=\"https://web.dev/compat2021/\" target=\"_blank\" rel=\"nofollow\"\u003eCompat2021: Eliminating five top compatibility pain points on the web\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: sakito\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCompat2021という取り組みの紹介記事になります。\n同時に\u003ca href=\"https://blogs.windows.com/msedgedev/2021/03/22/better-compatibility-compat2021/\" target=\"_blank\" rel=\"nofollow\"\u003eマイクロソフト\u003c/a\u003e、\u003ca href=\"https://www.igalia.com/2021/03/22/Igalia-and-Compat2021.html\" target=\"_blank\" rel=\"nofollow\"\u003eIgalia\u003c/a\u003eからもCompat2021についての各社の取り組みについて記事が公開されています。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://insights.developer.mozilla.org/reports/mdn-browser-compatibility-report-2020.html\" target=\"_blank\" rel=\"nofollow\"\u003eWebDNA\u003c/a\u003eなどを通して行われてきた調査で浮き彫りになった開発者が感じている問題について「ブラウザーの互換性」が多くあがっており、その問題について改善していくという内容になっています。\n特にCSS関連でCSS Flexbox, CSS Grid, CSS position: sticky, CSS aspect-ratio property, CSS transformsが各ブラウザで微妙に挙動が異なることによる辛さが多く挙げられているので、ここを2021年は改善していくとのことです。\u003c/p\u003e\n\u003cp\u003e記事では具体的にどのような挙動の差があるのかもまとまっています。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://groups.google.com/g/compat2021\" target=\"_blank\" rel=\"nofollow\"\u003eメーリングリスト\u003c/a\u003eや\u003ca href=\"https://wpt.fyi/compat2021?feature=summary\" target=\"_blank\" rel=\"nofollow\"\u003eweb-platform-tests dashboard - Compat 2021 Dashboard\u003c/a\u003eで情報を追いかけることができるのと、今後も継続的にこの問題について情報があがってくるようです。\u003c/p\u003e\n\u003cp\u003eChromium以外にもGeckoやWebKitも改善されないと意味がないような気がしますが、WebKitについてはIgaliaが取り組みについて触れているのでIgaliaがWebKitに協力していき、ほかのベンダーが共同でブラウザの改善に取り組むのかもしれません。\u003c/p\u003e\n\u003cp\u003eCSSの微妙な違いについてはかなり直面するケースでもあり、確認も大変なので嬉しい取り組みだと思います。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"テキストに隠し情報を埋め込むnpmモジュールを公開しました\"\u003e\u003ca href=\"#%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%81%AB%E9%9A%A0%E3%81%97%E6%83%85%E5%A0%B1%E3%82%92%E5%9F%8B%E3%82%81%E8%BE%BC%E3%82%80npm%E3%83%A2%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB%E3%82%92%E5%85%AC%E9%96%8B%E3%81%97%E3%81%BE%E3%81%97%E3%81%9F\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e\u003ca href=\"https://zenn.dev/redshoga/articles/ca28db8afd6b44\" target=\"_blank\" rel=\"nofollow\"\u003eテキストに隠し情報を埋め込むnpmモジュールを公開しました\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: nakajmg\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e電子透かしを入れることなどを目的とした、表示されない文字を使ってテキストにデータを埋め込む話。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eテ​​​‌‌‌​​​‌‌‌‌‌​‌​‌​​‌​‌​​​​‌‌‌​​​‌‌‌‌‌​‌​‌​‌‌​‌‌キ​​​‌‌‌​​​‌‌‌‌‌​​​‌‌​​​‌‌​​​‌‌‌​​​‌‌‌‌‌​‌​‌​‌‌​​‌ス​​​‌‌‌​​​‌‌‌‌‌​‌​‌​​​‌​‌​​​‌‌‌​​​‌‌‌‌‌​​​‌‌​‌​‌​ト​​​‌‌‌​​​‌‌‌‌‌​​​‌​‌​​‌​​​​‌‌‌​​​‌‌‌‌‌​​​‌​​‌‌​​を​​​‌‌‌​​​‌‌‌‌‌​​​‌‌‌​‌‌‌​​​‌‌‌​​​‌‌‌‌‌​‌​‌​‌​‌‌‌コ​​​‌‌‌​​​‌‌‌‌‌​​​‌​​‌‌​​​​​‌‌‌​​​‌‌‌‌‌​​​‌‌‌​‌‌​ピ​​​‌‌‌​​​‌‌‌‌‌​​​‌‌​​​​‌​​​‌‌‌​​​‌‌‌‌‌​​​‌​​‌‌​​ー​​​‌‌‌​​​‌‌‌‌‌​‌​‌​​​‌‌​​​​‌‌‌​​​‌‌‌‌‌​​​‌​‌​‌​‌し​​​‌‌‌​​​‌‌‌‌‌​​​‌​​​​‌‌てね\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e👆のテキストをコピーして \u003ca href=\"https://zero-width-watermark-web.vercel.app/\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://zero-width-watermark-web.vercel.app/\u003c/a\u003e で XTRACT MODEにしてコピペしてExtractを実行すると…。\u003c/p\u003e\n\u003cp\u003e👐\u003c/p\u003e\n\u003cp\u003e実装としてはテキストをUint8Arrayに変換して\u003ccode\u003e0\u003c/code\u003eと\u003ccode\u003e1\u003c/code\u003eをゼロ幅文字(\u003ccode\u003e0x200c\u003c/code\u003eと\u003ccode\u003e0x200b\u003c/code\u003e)に変換して埋め込んでいます。\u003c/p\u003e\n\u003cp\u003eこの手法は数年前に話題になったことがありました。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://labs.cybozu.co.jp/blog/akky/2018/04/leaker-detection-by-zero-width-characters/\" target=\"_blank\" rel=\"nofollow\"\u003eゼロ幅文字にエンコードした隠し情報で、文書をリークしたメンバーを特定\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"how-mdns-site-search-works---mozilla-hacks---the-web-developer-blog\"\u003e\u003ca href=\"#how-mdns-site-search-works---mozilla-hacks---the-web-developer-blog\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e\u003ca href=\"https://hacks.mozilla.org/2021/03/how-mdns-site-search-works/\" target=\"_blank\" rel=\"nofollow\"\u003eHow MDN's site-search works - Mozilla Hacks - the Web developer blog\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: zaki___yama\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eリニューアルしたMDNのサイト内検索のしくみの話。\u003c/p\u003e\n\u003cp\u003e2021年2月時点で、MDNには\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e英語のドキュメントが 11,619 ページ\u003c/li\u003e\n\u003cli\u003e翻訳されたドキュメントが約 40,000 ページ\u003c/li\u003e\n\u003cli\u003e英語だけで 530 万語\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e存在するそうです。\nビルド時にこれらのデータを全文検索データベースに突っ込んでインデックスする、ということをやっています。\nデータベースとして現在採用しているのは Elasticsearch です。\u003c/p\u003e\n\u003ch4 id=\"サイト全体のアーキテクチャ\"\u003e\u003ca href=\"#%E3%82%B5%E3%82%A4%E3%83%88%E5%85%A8%E4%BD%93%E3%81%AE%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eサイト全体のアーキテクチャ\u003c/h4\u003e\n\u003cp\u003e以下の図がわかりやすい。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://hacks.mozilla.org/files/2021/03/Untitled-Diagram-4.png\" alt=\"mdn-architecture\"\u003e\u003c/p\u003e\n\u003cp\u003eサイトのコンテンツを Elasticsearch に突っ込む、という処理を GitHub Actions で定期実行しています。 (24h おき)\nまた、検索時はフロントエンドからの fetch() リクエストを一旦 Django で構築したバックエンドが受け取り、クエリのバリデーションや整形をした後 Elasticsearch に送っています。\u003c/p\u003e\n\u003ch4 id=\"インデックス化までの流れ\"\u003e\u003ca href=\"#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E5%8C%96%E3%81%BE%E3%81%A7%E3%81%AE%E6%B5%81%E3%82%8C\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eインデックス化までの流れ\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eビルド時、コンテンツから index.html と一緒に index.json というデータを生成する。これは以下のようなデータ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-json\"\u003e\u003ccode class=\"language-json\"\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token property\"\u003e\"doc\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"title\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"DOCUMENT TITLE\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"summary\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"DOCUMENT SUMMARY\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n    \u003cspan class=\"token property\"\u003e\"body\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\n      \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n        \u003cspan class=\"token property\"\u003e\"type\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"prose\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \n        \u003cspan class=\"token property\"\u003e\"value\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n          \u003cspan class=\"token property\"\u003e\"id\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"introduction\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \n          \u003cspan class=\"token property\"\u003e\"title\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"INTRODUCTION\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n          \u003cspan class=\"token property\"\u003e\"content\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"\u0026#x3C;p\u003eFIRST BLOCK OF TEXTS\u0026#x3C;/p\u003e\"\u003c/span\u003e\n       \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n     \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n     ...\n   \u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n   \u003cspan class=\"token property\"\u003e\"popularity\"\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token number\"\u003e0.12345\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e\n   ...\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cul\u003e\n\u003cli\u003ePython のスクリプトで、index.json のHTMLからタグを取り除いた純粋なコンテンツを得る\n\u003cul\u003e\n\u003cli\u003eこれは \u003ccode\u003e\u0026#x3C;p\u003eSome \u0026#x3C;em\u003ecool\u0026#x3C;/em\u003e text.\u0026#x3C;/p\u003e\u003c/code\u003e -\u003e \u003ccode\u003eSome cool text.\u003c/code\u003e のような単純な処理だけではなく、 \u003ccode\u003e\u0026#x3C;div class=\"hidden\"\u003e\u003c/code\u003e や \u003ccode\u003e\u0026#x3C;div class=\"notecard warning\"\u003e\u003c/code\u003e なども取り除く必要がある\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eElasticsearch に送る\u003c/li\u003e\n\u003cli\u003e...という処理を 24 時間おきに GitHub Actions で実行\n\u003cul\u003e\n\u003cli\u003eproduction build 用の GitHub Action はおそらく \u003ca href=\"https://github.com/mdn/yari/blob/main/.github/workflows/prod-build.yml\" target=\"_blank\" rel=\"nofollow\"\u003eprod-build.yml\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e削除されたページのインデックスなどを考慮し、Elasticsearch 側は毎回インデックスを全削除 -\u003e 再作成している\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"検索\"\u003e\u003ca href=\"#%E6%A4%9C%E7%B4%A2\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e検索\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eフロントエンドからは \u003ccode\u003efetch()\u003c/code\u003e で \u003ccode\u003eGET /api/v1/search?q=foo\u0026#x26;locale=fr\u003c/code\u003e のようなエンドポイントを叩く\u003c/li\u003e\n\u003cli\u003eバックエンドでは Django のアプリがこのクエリをバリデーションし Elasticsearch 用のクエリに変換して検索\n\u003cul\u003e\n\u003cli\u003eelasticsearch-dsl というライブラリを使っている\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e検索結果のソート：popularity という数値を定義し、popularity と matchness を組み合わせてソートしてる\n\u003cul\u003e\n\u003cli\u003epopularity: Google Analytics の PV 数（定期的にダウンロードしてる）を 0 ~ 1 の値に正規化したもの\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch3 id=\"error-cause-in-javascript---dev-community\"\u003e\u003ca href=\"#error-cause-in-javascript---dev-community\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e\u003ca href=\"https://dev.to/hemanth/error-cause-in-javascript-425d\" target=\"_blank\" rel=\"nofollow\"\u003eError Cause in JavaScript - DEV Community\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: pirosikick\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eErrorのコンストラクタの第2引数に他のエラーを渡すことができるプロポーザルについて。知らぬ間にもうStage 3になっていた。\n下流で起きたエラーを上流に流していく過程で、エラーメッセージを連結したり、独自のエラーを作ったりせずに、\nこのような言語で公式の方法ができると色々と使いまわしがよさそう。\n（Golangではエラーをラップして返すのはおなじみで、結構便利。）\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e cause \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'…'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e err \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'…'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e cause \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ecause\u003c/span\u003e \u003cspan class=\"token operator\"\u003e===\u003c/span\u003e cause\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// true\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e同じようなことをやってくれる\u003ca href=\"https://www.npmjs.com/package/verror\" target=\"_blank\" rel=\"nofollow\"\u003everror\u003c/a\u003eというのがあるが、\nたぶんUniversalじゃないし、そこまでメジャーでは無い気がする。\nこの提案をベースに、Golangの\u003ccode\u003eerrors.As\u003c/code\u003eみたいなのを作ると便利そう。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-ts\"\u003e\u003ccode class=\"language-ts\"\u003e\u003cspan class=\"token comment\"\u003e// errがtype型のErrorをcauseに持っている場合に返す\u003c/span\u003e\n\u003cspan class=\"token comment\"\u003e// 適当に書いたので間違いあるかも！\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003efunction\u003c/span\u003e \u003cspan class=\"token generic-function\"\u003e\u003cspan class=\"token function\"\u003eerrorAs\u003c/span\u003e\u003cspan class=\"token generic class-name\"\u003e\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\n  \u003cspan class=\"token constant\"\u003eT\u003c/span\u003e \u003cspan class=\"token keyword\"\u003eextends\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e...\u003c/span\u003eargs\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token builtin\"\u003eany\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e InstanceType\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token constant\"\u003eT\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e Error\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token constant\"\u003eT\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e InstanceType\u003cspan class=\"token operator\"\u003e\u0026#x3C;\u003c/span\u003e\u003cspan class=\"token constant\"\u003eT\u003c/span\u003e\u003cspan class=\"token operator\"\u003e\u003e\u003c/span\u003e \u003cspan class=\"token operator\"\u003e|\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ewhile\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr \u003cspan class=\"token keyword\"\u003einstanceof\u003c/span\u003e \u003cspan class=\"token class-name\"\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e err\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n    err \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e err\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003ecause\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enull\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e cause \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eMyError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'...'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e err \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003eError\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'...'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e cause \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token function\"\u003eerrorAs\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eerr\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e MyError\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ee\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token comment\"\u003e// eはMyErrorとして扱える\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003chr\u003e\n\u003ch3 id=\"post-spectre-web-development\"\u003e\u003ca href=\"#post-spectre-web-development\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e\u003ca href=\"https://www.w3.org/TR/2021/WD-post-spectre-webdev-20210316/\" target=\"_blank\" rel=\"nofollow\"\u003ePost-Spectre Web Development\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: shisama\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eSpectre以降のWeb開発について脅威モデルと対策の実践例が解説されているドキュメントがW3CのWorking Draft(草案)として公開されました。元々GoogleのMike West氏が書いた文書でしたがW3C organizationに移りました。\u003cbr\u003e\nSpectreのようなサイドチャネル攻撃はハードウェアの脆弱性に起因するものなので、Same-Origin Policyでは防ぐことができません。機密情報が攻撃者によって操作可能なプロセスの中にあった場合、サイドチャネル攻撃によって情報の推測がされることが実証されています。JavaScriptを使ったSpectreのPoCも公開されました。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://security.googleblog.com/2021/03/a-spectre-proof-of-concept-for-spectre.html\" target=\"_blank\" rel=\"nofollow\"\u003eGoogle Online Security Blog: A Spectre proof-of-concept for a Spectre-proof web\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eプロセスレベルでサイトを分離するChromiumの\u003ca href=\"https://www.chromium.org/Home/chromium-security/site-isolation\" target=\"_blank\" rel=\"nofollow\"\u003eSite Isolation\u003c/a\u003eやFirefoxの\u003ca href=\"https://wiki.mozilla.org/Project_Fission\" target=\"_blank\" rel=\"nofollow\"\u003eProject Fission\u003c/a\u003eがあり、これらはデフォルトで有効となっているため、eTLD+1が異なるURLのサイトはプロセスが別となります。\u003cbr\u003e\nただ、すべてのブラウザがこれを実装するのは難しいため、Opt-inで対策可能なHTTPヘッダーを用意しています。\u003c/p\u003e\n\u003cp\u003eこの文書ではそれらのHTTPヘッダーの設定方法が詳しく紹介されています。\u003cbr\u003e\n『\u003ca href=\"https://developers-jp.googleblog.com/2021/03/blog-post_29.html\" target=\"_blank\" rel=\"nofollow\"\u003eGoogle Developers Japan: サイドチャネル攻撃への対策\u003c/a\u003e』でも紹介されている内容+補足は以下の通り。\u003cbr\u003e\nこれはW3CのドキュメントのTL;DRにも書かれている内容です。\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e受信したヘッダーを調べ、一方で Origin ヘッダー、もう一方で Sec-Fetch- で始まる各ヘッダーに注目し、\u003cstrong\u003eリクエストに応答するべきかどうかを判断します\u003c/strong\u003e。\n\u003cul\u003e\n\u003cli\u003e(補足)\u003ccode\u003eSec-Fetch-*\u003c/code\u003eからはじまるFetch Metadataはリクエスト時にChromeによって自動で付与されます。Fetch Metadataにはどこからきたどのようなリクエストかの情報が含まれています。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e攻撃者がリソースをサブリソースとして読み込む機能を制限します\u003c/strong\u003e。これをするには、Cross-Origin Resource Policy として same-origin を設定します（必要な場合のみ、same-site または cross-origin にします）。\n\u003cul\u003e\n\u003cli\u003e(補足)配信されるリソースに設定します。CDNなどで配信しているようなCross-Originで使われるリソースには値にcross-originを設定する必要があります。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e攻撃者がリソースをドキュメントとしてフレームに含めることができるかを制限します\u003c/strong\u003e。これをするには、X-Frame-Options: SAMEORIGIN を使ってフレーム化保護にオプトインするか、さらに細かい制御が可能な CSP の frame-ancestors ディレクティブを使います。たとえば、\u003ccode\u003eframe-ancestors 'self' https://trusted.embedder\u003c/code\u003e とします。\n\u003cul\u003e\n\u003cli\u003e(補足)iframeなどに埋め込めることができるページをSame-Originに制限したり、指定したOriginのみに制限できます。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003e攻撃者がアプリケーションのウィンドウを参照する機能を制限します\u003c/strong\u003e。これをするには、Cross-Origin Opener Policy を設定します。制限が強い same-origin 値をデフォルトとし、必要な場合のみ same-origin-allow-popups または unsafe-none にするのが最適です。\n\u003cul\u003e\n\u003cli\u003e(補足) \u003ccode\u003eCross-Origin-Opener-Policy: same-origin\u003c/code\u003eが設定されているページから新しいウィンドウで開かれたCross-Originなページからは\u003ccode\u003ewindow.opener\u003c/code\u003eの値がnullになります。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eMIME-type confusion 攻撃を防ぎ\u003c/strong\u003e、Cross-Origin Read Blocking（クロスオリジン読み込みブロック）などの消極的防御の確実性を高めます。これをするには、正しい Content-Type ヘッダーを設定し、X-Content-Type-Options: nosniff となっていることをグローバルで確認します。\n\u003cul\u003e\n\u003cli\u003e(補足)\u003ccode\u003e\u0026#x3C;img\u003e\u003c/code\u003eや\u003ccode\u003e\u0026#x3C;script\u003e\u003c/code\u003eを使って機密情報が含まれたHTMLやJSONを取得することを利用したサイドチャネル攻撃がある。たとえば\u003ccode\u003e\u0026#x3C;img src=\"https://example.com/secret.json\"\u003e\u003c/code\u003eのようなリクエストを攻撃者のサイトから行われたとき、見た目上は画像のパースに失敗して表示されないだけだが、攻撃者のコードのあるプロセス内のメモリに展開される。メモリに展開されたデータはサイドチャネル攻撃により推測可能となる。CORBはこのようなメモリへの展開を防ぐことができる機能です。\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eW3Cのドキュメントにはこれらの内容について実際のHTTPヘッダーの設定例をケースごとに実例を交えて解説しています。\u003c/p\u003e\n\u003cp\u003eまた、『\u003ca href=\"https://www.w3.org/TR/2021/WD-post-spectre-webdev-20210316/#documents-isolated\" target=\"_blank\" rel=\"nofollow\"\u003e2.2.1. Fully-Isolated Documents\u003c/a\u003e』のNoteにも書かれていますが、Chrome 91からSharedArrayBufferを使うためにはCross-Origin Isolateな状態でないと利用できなくなります。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://developer.chrome.com/blog/enabling-shared-array-buffer/#cross-origin-isolation\" target=\"_blank\" rel=\"nofollow\"\u003eSharedArrayBuffer updates in Android Chrome 88 and Desktop Chrome 91 - Chrome Developers\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eこれらの機能を使うためには次のようにCross-Originなページからのアクセスを防ぐ設定が必要です。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-unknown\"\u003e\u003ccode class=\"language-unknown\"\u003eCross-Origin-Embedder-Policy: require-corp\nCross-Origin-Opener-Policy: same-origin\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003ePerformance APIなどもSite IsolationやこれらのHTTPヘッダーの設定が必要です。サイドチャネル攻撃の可能性があるAPIはCross-Origin Isolatedでないと使えないようになるかもしれません。　　\nどのように設定すればいいか迷ったときはこのドキュメントを参考に設定すると良さそうです。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"sharedarraybuffer\"\u003e\u003ca href=\"#sharedarraybuffer\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eSharedArrayBuffer\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: koh110\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eChrome 91からSharedArrayBufferの利用するためにヘッダーを返さなければならなくなりました。\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://developer.chrome.com/blog/enabling-shared-array-buffer/\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://developer.chrome.com/blog/enabling-shared-array-buffer/\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e使っているつもりはなかったが検出された\u003c/li\u003e\n\u003cli\u003eNext.jsが入れているっぽい\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/vercel/next.js/issues/21708\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/vercel/next.js/issues/21708\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e依存して検出されてしまっているが影響はない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eReactの依存だった\n\u003cul\u003e\n\u003cli\u003e最終的にSharedArrayBufferへの依存が削除された\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/facebook/react/releases/tag/v17.0.2\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/releases/tag/v17.0.2\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/facebook/react/pull/20840\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/pull/20840\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eセキュリティなどの重大なissueではないためv16へのバックポートはない\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eもとをたどるとScheduler(React内部パッケージ)のプロファイリング機能で使われている\u003c/p\u003e\n\u003ch4 id=\"scheduler\"\u003e\u003ca href=\"#scheduler\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eScheduler\u003c/h4\u003e\n\u003cp\u003e元々はreact-schedulerというパッケージ\u003cbr\u003e\nreact-scheduler -\u003e schedule -\u003e scheduler\u003cbr\u003e\n\u003ca href=\"https://github.com/facebook/react/pull/13543\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/pull/13543\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/facebook/react/pull/13683\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/pull/13683\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/facebook/react/tree/master/packages/scheduler\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/tree/master/packages/scheduler\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e中身を読んでみるとイベントキューのようなもの\u003cbr\u003e\n\u003ca href=\"https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003erenameが繰り返されるうちに説明文が消えたっぽい。\u003cbr\u003e\nrequestAnimationFrameやrequestIdleCallbackより細かい優先度をつけて実行するというモチベーション。\u003cbr\u003e\n\u003ca href=\"https://github.com/facebook/react/blob/8a1e3962ab189b99b1593d8431feabcb4a21211b/packages/react-scheduler/src/ReactScheduler.js#L12-L23\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/blob/8a1e3962ab189b99b1593d8431feabcb4a21211b/packages/react-scheduler/src/ReactScheduler.js#L12-L23\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eNode.js + 古いIE環境を判定するために \u003ccode\u003etypeof setImmediate\u003c/code\u003e をみてるのがちょっと面白い。\n\u003ca href=\"https://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js#L555-L556\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/blob/master/packages/scheduler/src/forks/SchedulerDOM.js#L555-L556\u003c/a\u003e\u003c/p\u003e\n\u003ch4 id=\"profiler\"\u003e\u003ca href=\"#profiler\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eProfiler\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"https://reactjs.org/docs/profiler.html\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://reactjs.org/docs/profiler.html\u003c/a\u003e\n\u003ca href=\"https://gist.github.com/bvaughn/8de925562903afd2e7a12554adcdda16\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://gist.github.com/bvaughn/8de925562903afd2e7a12554adcdda16\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eSchedulerのプロファイリングには2つのアプローチが採用されている\u003cbr\u003e\n\u003ca href=\"https://github.com/facebook/react/pull/16145\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/pull/16145\u003c/a\u003e\u003cbr\u003e\n\u003ca href=\"https://github.com/facebook/react/pull/16542\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://github.com/facebook/react/pull/16542\u003c/a\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003esample base\n\u003cul\u003e\n\u003cli\u003eworkerからSchedulerの現在の状態を読み取る\u003c/li\u003e\n\u003cli\u003eworkerとSchedulerのデータを共有するためにSharedArrayBufferが使われている\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eevent base\n\u003cul\u003e\n\u003cli\u003eWorkerが初期化される前にプロファイリングするためのもの\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eプロファイリングはdevelopmentビルドでしか有効にされていないため、SharedArrayBufferの問題はproduction環境では起きないはず。\u003c/p\u003e\n\u003cp\u003eproduction環境でSharedArrayBufferの警告が出ている場合developmentビルドのままリリースしている可能性やProfilerをonにしている可能性があるので、アップデートできない環境やフレームワークで依存している場合は気にしてみるとよいかも。\u003cbr\u003e\n\u003ca href=\"https://gist.github.com/bvaughn/25e6233aeb1b4f0cdb8d8366e54a3977\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://gist.github.com/bvaughn/25e6233aeb1b4f0cdb8d8366e54a3977\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"tc39-2020-march0309-0310\"\u003e\u003ca href=\"#tc39-2020-march0309-0310\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eTC39 2020 March(\u003ca href=\"https://github.com/tc39/notes/blob/master/meetings/2021-03/mar-9.md\" target=\"_blank\" rel=\"nofollow\"\u003e03/09\u003c/a\u003e, \u003ca href=\"https://github.com/tc39/notes/blob/master/meetings/2021-03/mar-10.md\" target=\"_blank\" rel=\"nofollow\"\u003e03/10\u003c/a\u003e)\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: @__sosukesuzuki\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e数が多いのでいくつか興味深いかつあんまりメジャーではなさそうなものをあえて紹介。\u003c/p\u003e\n\u003ch4 id=\"class-static-initialization-blocks\"\u003e\u003ca href=\"#class-static-initialization-blocks\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eClass Static Initialization Blocks\u003c/h4\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token maybe-class-name\"\u003eClass\u003c/span\u003e \u003cspan class=\"token maybe-class-name\"\u003eFoo\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003estatic\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword\"\u003ethis\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003efoo\u003c/span\u003e \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token string\"\u003e\"foo\"\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e現在条件付きのStage-3。\u003c/p\u003e\n\u003cp\u003e前回の論点は２つあった。\u003c/p\u003e\n\u003cp\u003e一つはクラスごとに複数のStatic Blocksを許可するかどうかという点だった。結論としては、クラスは任意の数のStatic Blocksを含むことができるようになった。\u003c/p\u003e\n\u003cp\u003eもう一つは、Static Blocks内での\u003ccode\u003enew.target\u003c/code\u003e挙動についてだった。結論としては、メソッドと同じようにundefinedを返す必要があるということになった。\u003c/p\u003e\n\u003cp\u003eこの提案の中ではStatic Blocksに対するデコレータの扱いはサポートしていない。最終的にデコレータによるサポートが必要なのであれば、それはデコレータの提案の一部もしくは別のものとして議論する。\u003c/p\u003e\n\u003cp\u003eSpiderMonkeyやV8ではすでに実装が始まっている。\u003c/p\u003e\n\u003ch4 id=\"records-and-tuples-update\"\u003e\u003ca href=\"#records-and-tuples-update\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eRecords and Tuples update\u003c/h4\u003e\n\u003cp\u003e現在Stage-2。\u003c/p\u003e\n\u003cp\u003e2019年10月のStage-1のときのスライドでの議論に戻るが、TuplesやRecordsのために書いたコードは配列やオブジェクトに対しても動作するべきである。最近になって、配列のメソッドとTuplesのメソッドを照らし合わせていたところ、配列を操作する\u003ccode\u003epopped\u003c/code\u003e, \u003ccode\u003epushed\u003c/code\u003e, \u003ccode\u003ereversed\u003c/code\u003e, \u003ccode\u003eshifted\u003c/code\u003e, \u003ccode\u003espliced\u003c/code\u003e, \u003ccode\u003eunshifted\u003c/code\u003e, \u003ccode\u003ewith\u003c/code\u003e などのメソッドが配列には存在しないことがわかった。\u003c/p\u003e\n\u003cp\u003eもしこれらのメソッドが\u003ccode\u003eArray.prototype\u003c/code\u003eに存在すれば、この例のように配列を無駄にコピーする必要がなくなる。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-diff\"\u003e\u003ccode class=\"language-diff\"\u003e\u003cspan class=\"token deleted-sign deleted\"\u003e\u003cspan class=\"token prefix deleted\"\u003e-\u003c/span\u003e\u003cspan class=\"token line\"\u003e const a2 = [...a1].reverse();\u003c/span\u003e\n\u003cspan class=\"token line\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token inserted-sign inserted\"\u003e\u003cspan class=\"token prefix inserted\"\u003e+\u003c/span\u003e\u003cspan class=\"token line\"\u003e const a2 = a1.reversed();\u003c/span\u003e\n\u003cspan class=\"token line\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token deleted-sign deleted\"\u003e\u003cspan class=\"token prefix deleted\"\u003e-\u003c/span\u003e\u003cspan class=\"token line\"\u003e const a3 = [...a2].sort();\u003c/span\u003e\n\u003cspan class=\"token line\"\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan class=\"token inserted-sign inserted\"\u003e\u003cspan class=\"token prefix inserted\"\u003e+\u003c/span\u003e\u003cspan class=\"token line\"\u003e const a3 = a2.sorted();\u003c/span\u003e\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eTuplesのみならず配列にとっても有用なものである可能性が高い。\u003c/p\u003e\n\u003cp\u003eなので、これらのメソッドを\u003ccode\u003eArray.prototype\u003c/code\u003eや\u003ccode\u003eTuple.prototype\u003c/code\u003eに追加するというのを Records \u0026#x26; Tuples とは異なる新しいプロポーザルとして管理することが決まった。\u003c/p\u003e\n\u003ch4 id=\"async-do-update-towards-stage-2\"\u003e\u003ca href=\"#async-do-update-towards-stage-2\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eAsync Do update towards stage 2\u003c/h4\u003e\n\u003cp\u003e現在Stage-1。\u003c/p\u003e\n\u003cp\u003e前回からの変更点が２つある。\u003c/p\u003e\n\u003cp\u003e1つめは、\u003ccode\u003edo\u003c/code\u003eのブロックの中で\u003ccode\u003ebreak\u003c/code\u003e,\u003ccode\u003econtinue\u003c/code\u003e,\u003ccode\u003ereturn\u003c/code\u003eが使えるようになる。アンケートの結果そのような挙動に賛成する人が多かったため仕様に修正が加えられた。\u003c/p\u003e\n\u003cp\u003e２つ目は、\u003ccode\u003edo\u003c/code\u003eのブロックの最後の文として、\u003ccode\u003eelse\u003c/code\u003eなしの\u003ccode\u003eif\u003c/code\u003eは認めないようになった。\u003ccode\u003eif\u003c/code\u003eの直前の値を返すべきか、\u003ccode\u003eundefined\u003c/code\u003eを返すべきか不明瞭だからである。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token comment\"\u003e// x is 3? or undefined?\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e x \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e \u003cspan class=\"token keyword control-flow\"\u003edo\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token number\"\u003e3\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token boolean\"\u003efalse\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token number\"\u003e2\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eタイトルは\u003ccode\u003etowards stage 2\u003c/code\u003eだが、まだ固まっておらず今後設計を洗練させるという結論になった。\u003c/p\u003e\n\u003ch4 id=\"promiseanysettled\"\u003e\u003ca href=\"#promiseanysettled\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ePromise.anySettled\u003c/h4\u003e\n\u003cp\u003eこれは厳密にはプロポーザルではない。\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ePromise.race\u003c/code\u003eは統一性のために\u003ccode\u003ePromise.anySettled\u003c/code\u003eという名前であるべきではないかという議論。\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003ename\u003c/th\u003e\n\u003cth\u003edescription\u003c/th\u003e\n\u003cth\u003estatus\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003ePromise.allSettled\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e短絡しない\u003c/td\u003e\n\u003ctd\u003eES2020\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003ePromise.all\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e入力のどれかが失敗したら短絡する\u003c/td\u003e\n\u003ctd\u003eES2015\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003ePromise.race\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e入力のどれかが完了したら短絡する\u003c/td\u003e\n\u003ctd\u003eES2015\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003e\u003ccode\u003ePromise.any\u003c/code\u003e\u003c/td\u003e\n\u003ctd\u003e入力のどれかが成功したら短絡する\u003c/td\u003e\n\u003ctd\u003eES2021\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eこのような表にしてみるとわかりやすくなる。\u003c/p\u003e\n\u003cp\u003e新しい\u003ccode\u003ePromise.anySettled\u003c/code\u003eを導入、既存の\u003ccode\u003ePromise.race\u003c/code\u003eをその別名にして、全く同一の関数オブジェクトを指すようにするという提案。\u003c/p\u003e\n\u003cp\u003e結論としては、この提案はコンセンサスが得られなかった。\u003c/p\u003e\n\u003cp\u003e議論であげられている懸念が３つあった。\u003c/p\u003e\n\u003cp\u003e一つは、一度導入された関数の名前を変更するというのは互換性の観点からよくないということ。具体的にいえばAMPは\u003ccode\u003ePromise.race\u003c/code\u003eの名前に依存したAPIを提供しているらしい。\u003c/p\u003e\n\u003cp\u003eもうひとつは、プログラムは書かれることよりも読まれることが多いことを考えると、名前の異なる挙動が全く同じ関数を導入するというのは読み手に対して不親切であるという点。書くのみなら\u003ccode\u003ePromise.anySettled\u003c/code\u003eのみを覚えておけば問題ないが、読む場合には両方の関数とその関係を把握しておく必要が出てしまう。\u003c/p\u003e\n\u003cp\u003e最後の懸案は、単純に\u003ccode\u003erace\u003c/code\u003eと\u003ccode\u003eanySettled\u003c/code\u003eという２つの言葉の意味には違いがあるという点。ほとんどのPromiseに対する標準のオペレーションは\"success confluence\"(「計算の結果は、内部の処理の順番に影響されない」)という性質があり、入力のPromiseがすべて成功した場合には成功した順番に影響されない計算結果になるようになっている。\u003ccode\u003ePromise.race\u003c/code\u003eはこの性質に反する操作であり、それを強調するためにあえてこの名前が使われているらしい。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"announcing-the-deno-company\"\u003e\u003ca href=\"#announcing-the-deno-company\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e\u003ca href=\"https://deno.com/blog/the-deno-company\" target=\"_blank\" rel=\"nofollow\"\u003eAnnouncing the Deno Company\u003c/a\u003e\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: b4h0_c4t\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eDeno社が声明を発表していた。\u003c/p\u003e\n\u003cp\u003e要約すると、\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eDeno(以下、ランタイムを指す)はブラウザAPIに準拠したモダンなプログラミングシステムである\u003c/li\u003e\n\u003cli\u003e490万ドルのseed capitalを得たことでフルタイムの開発スタッフを確保できたため、タイムリーに開発が進むようになる。\u003c/li\u003e\n\u003cli\u003eDenoの展開は直接的なマネタイズが目的ではない\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e「490万ドルの資金調達に成功した」あたりが話題性の高い内容なのかなという感じでした。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"css-aspect-ratio-の各ブラウザ実装が揃いつつある\"\u003e\u003ca href=\"#css-aspect-ratio-%E3%81%AE%E5%90%84%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E5%AE%9F%E8%A3%85%E3%81%8C%E6%8F%83%E3%81%84%E3%81%A4%E3%81%A4%E3%81%82%E3%82%8B\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003eCSS \u003ccode\u003easpect-ratio\u003c/code\u003e の各ブラウザ実装が揃いつつある\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: narirow\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eCSSで比率を計算して要素のサイズを表現できる\u003ca href=\"https://drafts.csswg.org/css-sizing-4/#aspect-ratio\" target=\"_blank\" rel=\"nofollow\"\u003easpect-ratio\u003c/a\u003e、今月多くのブラウザで実装が進みました。各ブラウザの動向をまとめると以下のようなステータスです。\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eGoogleChrome: \u003ca href=\"https://groups.google.com/a/chromium.org/g/blink-dev/c/TF41VMfLhMI\" target=\"_blank\" rel=\"nofollow\"\u003e88でリリース済み (2020年10月)\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003eChrome90でaspect-ratioのCSSアニメーションに対応 (\u003ca href=\"https://blog.chromium.org/2021/03/chrome-90-beta-av1-encoder-for-webrtc.html\" target=\"_blank\" rel=\"nofollow\"\u003e参考\u003c/a\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eFirefox: \u003ca href=\"https://groups.google.com/g/mozilla.dev.platform/c/selXOOzcRkU/m/GKxYv-0kAAAJ\" target=\"_blank\" rel=\"nofollow\"\u003e88でリリース予定 (2021年4月)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eSafari: \u003ca href=\"https://trac.webkit.org/changeset/269641/webkit/\" target=\"_blank\" rel=\"nofollow\"\u003eTechnologyPreview117から徐々に対応、テスト中\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003easpect-ratioは、特に画像や映像のあとから読み込みされたときに発生するガタツキ(CLS)が以前より問題視されて、\u003ca href=\"https://github.com/WICG/intrinsicsize-attribute\" target=\"_blank\" rel=\"nofollow\"\u003eintrinsicsize\u003c/a\u003eなどのプロパティを経て、数年間議論が進んでいました。\n先立って、\u003ca href=\"https://developer.mozilla.org/en-US/docs/Web/Media/images/aspect_ratio_mapping#a_new_way_of_sizing_images_before_loading_completes\" target=\"_blank\" rel=\"nofollow\"\u003eブラウザの内部ではaspect-ratioを使用したスタイルをあてて、ガタツキが発生しないように調整\u003c/a\u003eが行われていたりします。\u003c/p\u003e\n\u003cp\u003e上記にも上がっていますが、Googleは\u003ca href=\"https://web.dev/compat2021/\" target=\"_blank\" rel=\"nofollow\"\u003eCompat2021\u003c/a\u003eというプロジェクトを立ち上げ、Webの互換性の問題に取り組んでいます。\u003ca href=\"https://web.dev/compat2021/#css-aspect-ratio-property\" target=\"_blank\" rel=\"nofollow\"\u003easpect-ratioプロパティ\u003c/a\u003eはその中でも優先度の高いものとして取り上げられています。\u003c/p\u003e\n\u003cp\u003eプロダクションで使えるようになるのも、あと少しですね。\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"pwaでもスクリーンショットが登録できるように\"\u003e\u003ca href=\"#pwa%E3%81%A7%E3%82%82%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%E3%81%8C%E7%99%BB%E9%8C%B2%E3%81%A7%E3%81%8D%E3%82%8B%E3%82%88%E3%81%86%E3%81%AB\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003ePWAでもスクリーンショットが登録できるように\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: narirow\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"https://web.dev/add-manifest/#description\" target=\"_blank\" rel=\"nofollow\"\u003emanifest.json\u003c/a\u003eがAndroidChromeで強化されます。\n\u003ccode\u003escreenshots\u003c/code\u003eと、\u003ccode\u003edescription\u003c/code\u003eのフィールドを入力しておくと、アプリストアのような立地なインストール画面を立ち上げることができるようになります。\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"https://slack-imgs.com/?c=1\u0026#x26;o1=ro\u0026#x26;url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FExo2ZjSWEAMFTKr.jpg\" alt=\"リッチなインストール画面\"\u003e\u003c/p\u003e\n\u003cp\u003e(ChromiumDevツイートから転載: \u003ca href=\"https://twitter.com/ChromiumDev/status/1376472636058927104\" target=\"_blank\" rel=\"nofollow\"\u003ehttps://twitter.com/ChromiumDev/status/1376472636058927104\u003c/a\u003e)\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"laytoutshiftを効率的にdebugする-webdev--chrome90でcls算出方法がアップデート\"\u003e\u003ca href=\"#laytoutshift%E3%82%92%E5%8A%B9%E7%8E%87%E7%9A%84%E3%81%ABdebug%E3%81%99%E3%82%8B-webdev--chrome90%E3%81%A7cls%E7%AE%97%E5%87%BA%E6%96%B9%E6%B3%95%E3%81%8C%E3%82%A2%E3%83%83%E3%83%97%E3%83%87%E3%83%BC%E3%83%88\" aria-hidden=\"true\" tabindex=\"-1\"\u003e\u003cspan class=\"icon icon-link\"\u003e\u003c/span\u003e\u003c/a\u003e\u003ca href=\"https://web.dev/debugging-layout-shifts/\" target=\"_blank\" rel=\"nofollow\"\u003eLaytoutShiftを効率的にdebugする (web.dev)\u003c/a\u003e + Chrome90でCLS算出方法がアップデート\u003c/h3\u003e\n\u003cul\u003e\n\u003cli\u003e共有者: narirow\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eweb.devでCoreWebVitalsの一つである、レイアウトシフトのデバッグ方法について詳細に記載れています。\nレイアウトシフトに換算される要素は \u003cstrong\u003e直近でユーザーの入力に基づいて変更されていない要素\u003c/strong\u003eで、これは PerformanceObserverで検出されるデータのうち、\u003ccode\u003ehadRecentInput\u003c/code\u003eがfalseになっている要素が該当します。\u003c/p\u003e\n\u003cp\u003e以下のようなスクリプトをChromeのデバッグツールのsnippetを追加したり、bookmarkletとして用意しておくとConsole画面で便利にデバッグ出来ます。\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-js\"\u003e\u003ccode class=\"language-js\"\u003e\u003cspan class=\"token keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"token class-name\"\u003ePerformanceObserver\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token parameter\"\u003eentryList\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token arrow operator\"\u003e=\u003e\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword control-flow\"\u003efor\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token keyword\"\u003econst\u003c/span\u003e entry \u003cspan class=\"token keyword\"\u003eof\u003c/span\u003e entryList\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003egetEntries\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token keyword control-flow\"\u003eif\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token operator\"\u003e!\u003c/span\u003eentry\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003ehadRecentInput\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n      cls \u003cspan class=\"token operator\"\u003e+=\u003c/span\u003e entry\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token property-access\"\u003evalue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token keyword\"\u003edebugger\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n      \u003cspan class=\"token console class-name\"\u003econsole\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003elog\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token string\"\u003e'Current CLS value:'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e cls\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e entry\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n    \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token method function property-access\"\u003eobserve\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003etype\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token string\"\u003e'layout-shift'\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e buffered\u003cspan class=\"token operator\"\u003e:\u003c/span\u003e \u003cspan class=\"token boolean\"\u003etrue\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003e(web.devより転載)\u003c/p\u003e\n\u003cp\u003eCLSの検出方法は、実は日々アップデートされています。この更新は\u003ca href=\"https://chromium.googlesource.com/chromium/src/+/master/docs/speed/metrics_changelog/cls.md\" target=\"_blank\" rel=\"nofollow\"\u003eChromeSpeed\u003c/a\u003eのページから見ることが出来ます。Chrome89から、\u003ccode\u003eopacity:0\u003c/code\u003eが当てられているような\u003ca href=\"https://chromium.googlesource.com/chromium/src/+/master/docs/speed/metrics_changelog/2020_12_cls.md\" target=\"_blank\" rel=\"nofollow\"\u003e目に見えない要素がCLSから換算されなく\u003c/a\u003eなり、Chrome90でもこの方向性が強化され、\u003ca href=\"https://chromium.googlesource.com/chromium/src/+/master/docs/speed/metrics_changelog/2021_02_cls.md\" target=\"_blank\" rel=\"nofollow\"\u003e空白のテキストやtransformなどの不具合も修正\u003c/a\u003eされます。\u003c/p\u003e\n\u003cp\u003eCoreWebVitalsの対応を行っている方は、Chrome90がリリースされた後、変化が起きないかSearchConsoleから確認してみると良いでしょう。\u003c/p\u003e\n"},"__N_SSG":true},"page":"/posts/[slug]","query":{"slug":"2021-03"},"buildId":"NpWyftPghPL3KcdiNy9a1","runtimeConfig":{"basePath":""},"isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>